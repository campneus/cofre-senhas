<!-- views/passwords.handlebars -->
<div>
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Gerenciamento de Senhas</h2>
            <p class="text-gray-600" id="passwordSectionSubtitle">
                {{#if categoryTitle}}
                    {{categoryTitle}}
                {{else}}
                    Gerencie suas credenciais de acesso
                {{/if}}
            </p>
        </div>
        <button 
            data-toggle="modal" 
            data-target="passwordModal" 
            class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg transition duration-200 flex items-center space-x-2"
        >
            <i class="fas fa-plus"></i>
            <span>Nova Senha</span>
        </button>
    </div>

    <div class="bg-white rounded-lg shadow-md">
        <div class="p-6 border-b border-gray-200">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="flex items-center space-x-4">
                    <form action="{{#if category}}/passwords/category/{{category}}{{else}}/passwords{{/if}}" method="GET" class="flex space-x-4">
                        <div class="relative">
                            <input 
                                type="text" 
                                name="search" 
                                placeholder="Buscar..." 
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                value="{{search}}"
                            >
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <select name="category" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-yellow-500" onchange="this.form.submit()">
                            <option value="" {{#ifnoteq category}}selected{{/ifnoteq}}>Todas as categorias</option>
                            <option value="prefeituras" {{#ifeq category "prefeituras"}}selected{{/ifeq}}>Prefeituras</option>
                            <option value="fornecedores" {{#ifeq category "fornecedores"}}selected{{/ifeq}}>Fornecedores</option>
                            <option value="orgaos" {{#ifeq category "orgaos"}}selected{{/ifeq}}>Órgãos Governamentais</option>
                            <option value="b2fleet" {{#ifeq category "b2fleet"}}selected{{/ifeq}}>B2Fleet e Locadoras</option>
                        </select>
                        <button type="submit" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg">
                            <i class="fas fa-filter mr-2"></i>Filtrar
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sistema</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localidade</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Atualização</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="passwordTableBody">
                    {{#each passwords}}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{this.system_name}}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{this.location.name}}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{this.username}}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <a href="{{this.url}}" target="_blank" class="text-sm text-blue-600 hover:text-blue-800">{{this.url}}</a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{formatDate this.last_updated}}</div>
                                <div class="text-xs text-gray-500">por {{this.updater.name}}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button 
                                    onclick="viewPassword('{{this.id}}')" 
                                    class="text-blue-600 hover:text-blue-900"
                                    data-tooltip="Visualizar"
                                >
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button 
                                    onclick="editPassword('{{this.id}}')" 
                                    class="text-yellow-600 hover:text-yellow-900"
                                    data-tooltip="Editar"
                                >
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form action="/passwords/{{this.id}}?_method=DELETE" method="POST" class="inline">
                                    <button 
                                        type="submit" 
                                        onclick="return confirm('Tem certeza que deseja excluir esta credencial?')"
                                        class="text-red-600 hover:text-red-900"
                                        data-tooltip="Excluir"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {{/each}}
                    {{#unless passwords.length}}
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                Nenhuma credencial encontrada.
                            </td>
                        </tr>
                    {{/unless}}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Nova Credencial</h3>
                <button data-dismiss="modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <form class="p-6 space-y-6" id="passwordForm" action="/passwords" method="POST" data-validate="true">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="form-label">Categoria</label>
                    <select name="category" class="form-select" required>
                        <option value="">Selecione uma categoria</option>
                        <option value="prefeituras">Prefeituras</option>
                        <option value="fornecedores">Fornecedores</option>
                        <option value="orgaos">Órgãos Governamentais</option>
                        <option value="b2fleet">B2Fleet e Locadoras</option>
                    </select>
                </div>

                <div>
                    <label class="form-label">Localidade</label>
                    <select name="location_id" class="form-select" required>
                        <option value="">Selecione uma localidade</option>
                        {{#each locations}}
                            <option value="{{this.id}}">{{this.name}}</option>
                        {{/each}}
                    </select>
                </div>

                <div>
                    <label class="form-label">Nome do Sistema</label>
                    <input name="system_name" type="text" class="form-input" placeholder="Ex: Portal Municipal" required>
                </div>

                <div>
                    <label class="form-label">URL</label>
                    <input name="url" type="url" class="form-input" placeholder="https://exemplo.com" required>
                </div>

                <div>
                    <label class="form-label">Usuário</label>
                    <input name="username" type="text" class="form-input" placeholder="Nome de usuário" required>
                </div>

                <div>
                    <label class="form-label">Senha</label>
                    <div class="relative">
                        <input 
                            name="password" 
                            type="password" 
                            id="passwordInput" 
                            class="form-input pr-12"
                            placeholder="Senha" 
                            required
                        >
                        <button type="button" class="password-toggle">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Data de Expiração</label>
                    <input name="expiry_date" type="date" class="form-input">
                </div>
            </div>

            <div>
                <label class="form-label">Observações</label>
                <textarea name="notes" class="form-input h-24" placeholder="Observações adicionais (opcional)"></textarea>
            </div>

            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <button type="button" data-dismiss="modal" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
                    Cancelar
                </button>
                <button type="submit" class="px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition duration-200">
                    Salvar Credencial
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // View password details
    function viewPassword(id) {
        fetch(`/passwords/${id}`)
            .then(response => response.json())
            .then(data => {
                // Create modal to show password details
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-semibold text-gray-800">${data.system_name}</h3>
                                <button class="text-gray-400 hover:text-gray-600 close-modal">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">Categoria</p>
                                    <p class="font-medium">${getCategoryName(data.category)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Localidade</p>
                                    <p class="font-medium">${data.location ? data.location.name : 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">URL</p>
                                    <p class="font-medium">
                                        <a href="${data.url}" target="_blank" class="text-blue-600 hover:text-blue-800">${data.url}</a>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Usuário</p>
                                    <div class="flex items-center space-x-2">
                                        <p class="font-medium">${data.username}</p>
                                        <button onclick="copyToClipboard('${data.username}')" class="text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Senha</p>
                                    <div class="flex items-center space-x-2">
                                        <p class="font-medium password-field">••••••••</p>
                                        <button class="text-gray-400 hover:text-gray-600 toggle-password" data-password="${data.password}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="copyToClipboard('${data.password}')" class="text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Data de Expiração</p>
                                    <p class="font-medium">${data.expiry_date ? new Date(data.expiry_date).toLocaleDateString('pt-BR') : 'N/A'}</p>
                                </div>
                            </div>
                            
                            <div>
                                <p class="text-sm text-gray-500">Observações</p>
                                <p class="font-medium">${data.notes || 'Nenhuma observação'}</p>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-gray-200 text-xs text-gray-500">
                                <p>Criado por ${data.creator ? data.creator.name : 'N/A'} em ${new Date(data.createdAt).toLocaleDateString('pt-BR')}</p>
                                <p>Última atualização por ${data.updater ? data.updater.name : 'N/A'} em ${new Date(data.last_updated).toLocaleDateString('pt-BR')}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add event listeners
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    modal.remove();
                });
                
                modal.querySelector('.toggle-password').addEventListener('click', function() {
                    const passwordField = modal.querySelector('.password-field');
                    const icon = this.querySelector('i');
                    const password = this.getAttribute('data-password');
                    
                    if (passwordField.textContent === '••••••••') {
                        passwordField.textContent = password;
                        icon.className = 'fas fa-eye-slash';
                    } else {
                        passwordField.textContent = '••••••••';
                        icon.className = 'fas fa-eye';
                    }
                });
                
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching password:', error);
                alert('Erro ao carregar detalhes da senha');
            });
    }
    
    // Helper function to get category display name
    function getCategoryName(category) {
        const categories = {
            'prefeituras': 'Prefeituras',
            'fornecedores': 'Fornecedores',
            'orgaos': 'Órgãos Governamentais',
            'b2fleet': 'B2Fleet e Locadoras'
        };
        return categories[category] || category;
    }
    
    // Edit password
    function editPassword(id) {
        fetch(`/passwords/${id}`)
            .then(response => response.json())
            .then(data => {
                // TODO: Implement edit functionality by populating the form
                // and changing the form action
                
                // Open the modal
                const modal = document.getElementById('passwordModal');
                modal.classList.remove('hidden');
                
                // Update title
                modal.querySelector('h3').textContent = 'Editar Credencial';
                
                // Update form
                const form = document.getElementById('passwordForm');
                form.action = `/passwords/${id}?_method=PUT`;
                
                // Populate form fields
                form.querySelector('[name="system_name"]').value = data.system_name;
                form.querySelector('[name="url"]').value = data.url;
                form.querySelector('[name="username"]').value = data.username;
                form.querySelector('[name="password"]').value = data.password;
                form.querySelector('[name="category"]').value = data.category;
                form.querySelector('[name="location_id"]').value = data.location_id;
                form.querySelector('[name="notes"]').value = data.notes || '';
                
                if (data.expiry_date) {
                    form.querySelector('[name="expiry_date"]').value = data.expiry_date.split('T')[0];
                }
            })
            .catch(error => {
                console.error('Error fetching password for edit:', error);
                alert('Erro ao carregar dados para edição');
            });
    }
</script>